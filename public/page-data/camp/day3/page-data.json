{"componentChunkName":"component---src-templates-camp-curriculum-js","path":"/camp/day3","result":{"data":{"markdownRemark":{"html":"<h2>Introduction</h2>\n<p>Today, we will take another step in our overall goal of creating a smart security system. Through our camera feed, we want to determine whether there is someone (or something) in the frame. To do this, we will use our knowledge of <code class=\"language-text\">OpenCV</code> to detect motion.</p>\n<p><img src=\"/static/day3_motion-022db0dd8799136a6a0043b36eb12cd4.jpeg\" alt=\"\"></p>\n<p>How do we achieve this?</p>\n<p>Well, first we need a way to stream the camera feed. In the past, we successfully captured still images from the camera, and even showed a preview of the feed for a few seconds. But now, we need a way to access the camera feed in a Python script.</p>\n<p>We would then need to figure out a way to detect any motion in the stream. We'll get back to this later, but for now, think of some ideas about how we can detect motion. Think about what exactly the \"motion\" is in terms of a stream of images. After all, a video is just a set of still images that you view in rapid succession.</p>\n<h2>1. Steady Camera Stream</h2>\n<p>First things first, let's stream the camera in Python. To do this, we will need the <code class=\"language-text\">picamera</code> module. Run the following in the terminal to download the necessary packages:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ python3 <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"import picamera\"</span></code></pre></div>\n<p>Install the following</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> upgrade\n\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> libatlas-base-dev\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> libjasper-dev\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> libqt5gui5 \n$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> libqt5webkit5 \n$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> libqt5test5 \n$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> libhdf5-dev\n\n$ <span class=\"token function\">sudo</span> pip3 <span class=\"token function\">install</span> flask\n$ <span class=\"token function\">sudo</span> pip3 <span class=\"token function\">install</span> numpy\n$ <span class=\"token function\">sudo</span> pip3 <span class=\"token function\">install</span> opencv-contrib-python<span class=\"token operator\">==</span><span class=\"token number\">4.5</span>.3.56\n$ <span class=\"token function\">sudo</span> pip3 <span class=\"token function\">install</span> imutils\n\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> portaudio19-dev python-all-dev python3-all-dev <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">sudo</span> pip3 <span class=\"token function\">install</span> pyaudio\n$ pip3 <span class=\"token function\">install</span> SpeechRecognition\n$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> flac\n\n$ pip3 <span class=\"token function\">install</span> numpy <span class=\"token parameter variable\">--upgrade</span></code></pre></div>\n<h3>a) Access Single Images</h3>\n<p>Let's start by accessing a single image from the camera stream. Create a new Python file called <code class=\"language-text\">motion_detection.py</code></p>\n<p>First, import the required libraries</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># import the necessary packages</span>\n<span class=\"token keyword\">from</span> picamera<span class=\"token punctuation\">.</span>array <span class=\"token keyword\">import</span> PiRGBArray\n<span class=\"token keyword\">from</span> picamera <span class=\"token keyword\">import</span> PiCamera\n<span class=\"token keyword\">import</span> time\n<span class=\"token keyword\">import</span> cv2</code></pre></div>\n<p>We then need to initialize a camera by calling <code class=\"language-text\">PiCamera()</code>. This will give us a reference to the raw camera capture component. The <code class=\"language-text\">raw_capture</code> object is especially useful since it gives us direct access to the camera stream and avoids the expensive compression to JPEG format, which we would then have to take and decode to <code class=\"language-text\">OpenCV</code> format anyway.</p>\n<p>Let's also change the camera resolution to <code class=\"language-text\">640x480</code> pixels. This dimension is arbitrary, but it will standardize our outputs later on.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber 0\" class=\"language-python line-numbers\"><code class=\"language-python\">camera <span class=\"token operator\">=</span> PiCamera<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ncamera<span class=\"token punctuation\">.</span>resolution <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">640</span><span class=\"token punctuation\">,</span> <span class=\"token number\">480</span><span class=\"token punctuation\">)</span>\nraw_capture <span class=\"token operator\">=</span> PiRGBArray<span class=\"token punctuation\">(</span>camera<span class=\"token punctuation\">,</span> size<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">640</span><span class=\"token punctuation\">,</span> <span class=\"token number\">480</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\ntime<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># allow time for the camera to warmup</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Next, we will capture a frame by calling <code class=\"language-text\">capture()</code> on the camera object we previously created. Being aware that the format is <code class=\"language-text\">BGR</code> and not the traditional <code class=\"language-text\">RGB</code>. This is extremely important because <code class=\"language-text\">OpenCV</code> represents images as <code class=\"language-text\">Numpy</code> arrays in <code class=\"language-text\">BGR</code> order rather than <code class=\"language-text\">RGB</code>. This little nuance is subtle, but very important to remember as it can lead to some confusing bugs in your code down the line.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># grab an image from the camera</span>\ncamera<span class=\"token punctuation\">.</span>capture<span class=\"token punctuation\">(</span>raw_capture<span class=\"token punctuation\">,</span> <span class=\"token builtin\">format</span><span class=\"token operator\">=</span><span class=\"token string\">\"bgr\"</span><span class=\"token punctuation\">)</span>\nimage <span class=\"token operator\">=</span> raw_capture<span class=\"token punctuation\">.</span>array</code></pre></div>\n<p>Now, let's display the image on the screen by using <code class=\"language-text\">cv2.imshow()</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">cv2<span class=\"token punctuation\">.</span>imshow<span class=\"token punctuation\">(</span><span class=\"token string\">\"Image\"</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">)</span>\ncv2<span class=\"token punctuation\">.</span>waitKey<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># wait indefinitely until a key is pressed</span></code></pre></div>\n<p>Test that this is working by running</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ python3 motion_detection.py</code></pre></div>\n<h3>b) Constant Streaming</h3>\n<p>Now that we have successfully used <code class=\"language-text\">OpenCV</code> to grab a single image from the camera, let’s move on to a video stream.</p>\n<p>The concept is similar to how we got a single image above. But instead of calling <code class=\"language-text\">capture</code> on the camera object, we will call <code class=\"language-text\">capture_continuous</code> instead. Intuitively right?</p>\n<p>But in order to process each individual frame in this continuous stream, we will need a for loop:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">for</span> frame <span class=\"token keyword\">in</span> camera<span class=\"token punctuation\">.</span>capture_continuous<span class=\"token punctuation\">(</span>raw_capture<span class=\"token punctuation\">,</span> <span class=\"token builtin\">format</span><span class=\"token operator\">=</span><span class=\"token string\">\"bgr\"</span><span class=\"token punctuation\">,</span> use_video_port<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    image <span class=\"token operator\">=</span> frame<span class=\"token punctuation\">.</span>array</code></pre></div>\n<p>The <code class=\"language-text\">capture_continuous</code> method returns a frame from the video stream. The frame then has an array property, which corresponds to the frame in <code class=\"language-text\">Numpy</code> array format. So, in order to get the image frame itself, we have to call <code class=\"language-text\">frame.array</code> to get the <code class=\"language-text\">Numpy</code> array representation of the image.</p>\n<p>Also, within the loop, we have to clear the <code class=\"language-text\">raw_capture</code> stream to get ready for the next frame.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">raw_capture<span class=\"token punctuation\">.</span>truncate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nraw_capture<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Finally, let’s wait for an \"escape\" key to be pressed in order to exit out of the infinite loop.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">key <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>waitKey<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># get the key pressed in the last millisecond</span>\n<span class=\"token keyword\">if</span> key <span class=\"token operator\">==</span> <span class=\"token builtin\">ord</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"q\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">break</span></code></pre></div>\n<p>In summary, you should have the following code in <code class=\"language-text\">motion_detection.py</code></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber 0\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">from</span> picamera<span class=\"token punctuation\">.</span>array <span class=\"token keyword\">import</span> PiRGBArray\n<span class=\"token keyword\">from</span> picamera <span class=\"token keyword\">import</span> PiCamera\n<span class=\"token keyword\">import</span> time\n<span class=\"token keyword\">import</span> cv2\n<span class=\"token comment\"># initialize the camera and grab a reference to the raw camera capture</span>\ncamera <span class=\"token operator\">=</span> PiCamera<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ncamera<span class=\"token punctuation\">.</span>resolution <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">640</span><span class=\"token punctuation\">,</span> <span class=\"token number\">480</span><span class=\"token punctuation\">)</span>\nraw_capture <span class=\"token operator\">=</span> PiRGBArray<span class=\"token punctuation\">(</span>camera<span class=\"token punctuation\">,</span> size<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">640</span><span class=\"token punctuation\">,</span> <span class=\"token number\">480</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># allow the camera to warmup</span>\ntime<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># capture frames from the camera</span>\n<span class=\"token keyword\">for</span> frame <span class=\"token keyword\">in</span> camera<span class=\"token punctuation\">.</span>capture_continuous<span class=\"token punctuation\">(</span>raw_capture<span class=\"token punctuation\">,</span> <span class=\"token builtin\">format</span><span class=\"token operator\">=</span><span class=\"token string\">\"bgr\"</span><span class=\"token punctuation\">,</span> use_video_port<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\t<span class=\"token comment\"># grab the raw NumPy array representing the image, then initialize the timestamp</span>\n\t<span class=\"token comment\"># and occupied/unoccupied text</span>\n\timage <span class=\"token operator\">=</span> frame<span class=\"token punctuation\">.</span>array\n\t<span class=\"token comment\"># show the frame</span>\n\tcv2<span class=\"token punctuation\">.</span>imshow<span class=\"token punctuation\">(</span><span class=\"token string\">\"Frame\"</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">)</span>\n\t<span class=\"token comment\"># clear the stream in preparation for the next frame</span>\n\traw_capture<span class=\"token punctuation\">.</span>truncate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    \traw_capture<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    \n    \t<span class=\"token comment\"># exit the loop when `q` is pressed</span>\n    \tkey <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>waitKey<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> key <span class=\"token operator\">==</span> <span class=\"token builtin\">ord</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"q\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        \t<span class=\"token keyword\">break</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>To run this program, go to the terminal and execute</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ python3 motion_detection.py</code></pre></div>\n<h2>2. What's the Difference?</h2>\n<p>Now, let's revisit our initial question. How do we detect motion within a camera stream? Hint: think of the camera stream as a series of image frames that are just shown in rapid succession.</p>\n<p><img src=\"/static/day3_frames-eb3a64b70a0b82c64d6a99677b70bea9.jpeg\" alt=\"\"></p>\n<p>What exactly is \"motion\" anyways? In the example above, we see that there are minor differences between each frame. If you put all of these minor differences together, you get \"motion\".</p>\n<p><img src=\"/static/day3_frames_animated-02572645740a21a3bdee09357a561091.gif\" alt=\"\"></p>\n<p>Today, we will explore what it means to use background subtraction between frames to detect motion.</p>\n<h3>What is Background Subtraction</h3>\n<p>Background subtraction is critical in many Computer Vision applications. We use it to count the number of cars passing through a toll booth. We use it to count the number of people walking in and out of a store.</p>\n<p>And we will now use it for motion detection.</p>\n<p>The base of this approach is that of detecting moving objects from the difference between the current frame and reference frame, which is often called ‘Background Image’ or ‘Background Model’. This background subtraction is typically done by detecting the foreground objects in a video frame and foreground detection is the main task of this whole approach.</p>\n<p>Any robust background subtraction model should be able to handle light intensity changes and repeated motion from long term scene changes. The analysis of such an approach mathematically can be modeled using a function <code class=\"language-text\">P(x,y,t)</code> as a video sequence where <code class=\"language-text\">t</code> is the time dimensions <code class=\"language-text\">x</code> and <code class=\"language-text\">y</code> are the pixel locations.</p>\n<p><img src=\"/static/day3_background_subtraction-02dc41d365bc9c1a1134922a55da59f9.png\" alt=\"\"></p>\n<p>Mathematically it can be modeled as:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">|reference_frame – current_frame| > Threshold</code></pre></div>\n<p>This approach can be used when segmenting motion-based objects such as cars, pedestrians etc.</p>\n<p>And it is very sensitive to threshold values. So depending on object structure, speed, frame rate and global threshold limit, this approach has limited use cases.</p>\n<p><img src=\"/static/day3_threshold-5c5897ec89d5f83c5ad7099877c35c3b.png\" alt=\"\"></p>\n<p>We will use background subtraction to detect motion because the background of our video stream is largely static and unchanging over consecutive frames of a video. Therefore, if we can model the background, we monitor it for substantial changes. If there is a substantial change, we can detect it — this change normally corresponds to motion in our video.</p>\n<h3>Implement Background Subtraction</h3>\n<p>Let's go back to our previous <code class=\"language-text\">motion_detection.py</code> file.</p>\n<p>Instead of showing the frame or image by 'cv2.imshow(\"Frame\", image)', we should check if <code class=\"language-text\">image</code> is <code class=\"language-text\">None</code>; as well as setting a default message of \"Not Detected\" to variable maybe_motion_text and later change it once we detect any motion.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">maybe_motion_text <span class=\"token operator\">=</span> <span class=\"token string\">\"Not Detected\"</span>\n<span class=\"token keyword\">if</span> image <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">break</span></code></pre></div>\n<p>Then, We will need to augment the incoming images. Let's convert the image to grayscale, as color has no bearing on motion detection other than adding noise to the data. We also apply Gaussian blurring to smooth our images.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">current_frame <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>cvtColor<span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span>cv2<span class=\"token punctuation\">.</span>COLOR_BGR2GRAY<span class=\"token punctuation\">)</span>\ncurrent_frame <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>GaussianBlur<span class=\"token punctuation\">(</span>current_frame<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token number\">21</span><span class=\"token punctuation\">,</span><span class=\"token number\">21</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Due to tiny variations in the digital camera sensors, no two frames will be 100% the same — some pixels will most certainly have different intensity values. That said, we need to account for this and apply Gaussian smoothing to average pixel intensities across an 21 x 21 region. This helps smooth out high frequency noise that could throw our motion detection algorithm off.</p>\n<p>For simplicity, let’s assume that the first frame we capture will contain no motion and just background. (Make sure the assumption is satisfied when you run the program.) So, we will store the first image input as the reference frame. Don't forget to set reference_frame to None initially!</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">if</span> reference_frame <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n    reference_frame <span class=\"token operator\">=</span> current_frame\n    <span class=\"token keyword\">continue</span></code></pre></div>\n<p>Here, if we see that there is currently no reference frame, we will use the image input as the reference frame and continue on to the next frame.</p>\n<p>Now that we have our background modeled via the <code class=\"language-text\">reference_frame</code> variable, we can utilize it to compute the difference between the initial frame and subsequent new frames from the video stream.</p>\n<p>Let's compute the absolute difference between the current frame and the reference frame.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">frame_delta <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>absdiff<span class=\"token punctuation\">(</span>reference_frame<span class=\"token punctuation\">,</span>current_frame<span class=\"token punctuation\">)</span>\nthresh <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>threshold<span class=\"token punctuation\">(</span>frame_delta<span class=\"token punctuation\">,</span> <span class=\"token number\">25</span><span class=\"token punctuation\">,</span> <span class=\"token number\">255</span><span class=\"token punctuation\">,</span> cv2<span class=\"token punctuation\">.</span>THRESH_BINARY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>Dilation fills holes and connects areas; it makes small differences a bit clearer by increasing the size and brightness. Thus, we can unite the little boxes together to form bigger detecting bounding boxes.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">thresh <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>dilate<span class=\"token punctuation\">(</span>thresh<span class=\"token punctuation\">,</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span>iterations<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>This will take the pixel density difference between the current and reference frames using the following formula:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">delta = |reference_frame – current_frame|</code></pre></div>\n<p>Now, we can use <code class=\"language-text\">cv2.threshold</code> to reveal regions of the image that only have significant changes in pixel intensity values. If the delta is less than 25, we discard the pixel and set it to black (i.e. background). If the delta is greater than 25, we’ll set it to white (i.e. foreground).</p>\n<p>It will look something like this:\n<img src=\"/static/day3_frame_delta_thresholded-1a30f317cfa59cc4ca6b315b4d0ff98e.jpg\" alt=\"\"></p>\n<p>Given this thresholded image, it’s simple to apply contour detection to find the outlines of these white regions. Don't forget to import imutils!</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">cnts <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>findContours<span class=\"token punctuation\">(</span>thresh<span class=\"token punctuation\">.</span>copy<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> cv2<span class=\"token punctuation\">.</span>RETR_EXTERNAL<span class=\"token punctuation\">,</span> cv2<span class=\"token punctuation\">.</span>CHAIN_APPROX_SIMPLE<span class=\"token punctuation\">)</span>\ncnts <span class=\"token operator\">=</span> imutils<span class=\"token punctuation\">.</span>grab_contours<span class=\"token punctuation\">(</span>cnts<span class=\"token punctuation\">)</span></code></pre></div>\n<p>We will now loop over each of the contours, where we’ll filter the small, irrelevant contours. If the contour area is larger than a pre-determined <code class=\"language-text\">min_area</code> value, we’ll draw the bounding box surrounding the foreground and motion region. We will use 15 as a default value for min_area so don't forget to initialize your 'min_area' as 15.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber 0\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">for</span> c <span class=\"token keyword\">in</span> cnts<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> cv2<span class=\"token punctuation\">.</span>contourArea<span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> min_area<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">continue</span>\n        <span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>w<span class=\"token punctuation\">,</span>h<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>boundingRect<span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span>\n        cv2<span class=\"token punctuation\">.</span>rectangle<span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>x<span class=\"token operator\">+</span>w<span class=\"token punctuation\">,</span>y<span class=\"token operator\">+</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">255</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>And that is all! We have just detected motion!</p>\n<p>To review, here is what we accomplished:</p>\n<ol>\n<li>use the first frame in the camera feed as the reference frame</li>\n<li>process each frame in a constant camera feed against the reference frame</li>\n<li>each frame is converted to grayscale and a Gaussian blur was applied (can you remember why the Gaussian filter was needed?)</li>\n<li>take the difference in pixel density between the reference frame and each subsequence frame</li>\n<li>find the \"contours\", where there is an obvious difference in pixel density (above a given threshold)</li>\n<li>for each contour, if it is larger than a pre-determined min_area threshold, draw a bounding box to label it as detected motion</li>\n</ol>\n<h3>Wrapping Up</h3>\n<p>To wrap up, let's visualize everything we have computed above using <code class=\"language-text\">cv2.imshow</code>.</p>\n<p>First, let's show whether motion was or was not detected, along with the date. Don't forget to import datetime!</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">cv2<span class=\"token punctuation\">.</span>putText<span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Motion: {}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>maybe_motion_text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> cv2<span class=\"token punctuation\">.</span>FONT_HERSHEY_SIMPLEX<span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\ncv2<span class=\"token punctuation\">.</span>putText<span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strftime<span class=\"token punctuation\">(</span><span class=\"token string\">\"%A %d %B %Y %I: %M: %S%p\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span>image<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> cv2<span class=\"token punctuation\">.</span>FONT_HERSHEY_SIMPLEX<span class=\"token punctuation\">,</span> <span class=\"token number\">0.35</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Here, we use a <code class=\"language-text\">maybe_motion_text</code> variable to store whether there was motion. Think about where you need to initialize this variable and when to change it in your code. If you need help, look to the full code script below.</p>\n<p>Now, let's open up three windows.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">cv2<span class=\"token punctuation\">.</span>imshow<span class=\"token punctuation\">(</span><span class=\"token string\">\"Feed\"</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">)</span>\ncv2<span class=\"token punctuation\">.</span>imshow<span class=\"token punctuation\">(</span><span class=\"token string\">\"Threshold\"</span><span class=\"token punctuation\">,</span> thresh<span class=\"token punctuation\">)</span>\ncv2<span class=\"token punctuation\">.</span>imshow<span class=\"token punctuation\">(</span><span class=\"token string\">\"Frame Delta\"</span><span class=\"token punctuation\">,</span> frame_delta<span class=\"token punctuation\">)</span></code></pre></div>\n<p>The first window will be our image (with bounding boxes around any detected motion). We will also open windows to show the frame delta and thresholded images (just for fun :D).</p>\n<h3>Full Python Program</h3>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber 0\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">from</span> picamera<span class=\"token punctuation\">.</span>array <span class=\"token keyword\">import</span> PiRGBArray\n<span class=\"token keyword\">from</span> picamera <span class=\"token keyword\">import</span> PiCamera\n<span class=\"token keyword\">import</span> imutils\n<span class=\"token keyword\">import</span> datetime\n<span class=\"token keyword\">import</span> time\n<span class=\"token keyword\">import</span> cv2\n\ncamera <span class=\"token operator\">=</span> PiCamera<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ncamera<span class=\"token punctuation\">.</span>resolution <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">640</span><span class=\"token punctuation\">,</span> <span class=\"token number\">480</span><span class=\"token punctuation\">)</span>\nraw_capture <span class=\"token operator\">=</span> PiRGBArray<span class=\"token punctuation\">(</span>camera<span class=\"token punctuation\">,</span> size<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">640</span><span class=\"token punctuation\">,</span> <span class=\"token number\">480</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\ntime<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\nreference_frame <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>\n\nmin_area <span class=\"token operator\">=</span> <span class=\"token number\">15</span>\n\n<span class=\"token keyword\">for</span> frame <span class=\"token keyword\">in</span> camera<span class=\"token punctuation\">.</span>capture_continuous<span class=\"token punctuation\">(</span>raw_capture<span class=\"token punctuation\">,</span> <span class=\"token builtin\">format</span><span class=\"token operator\">=</span><span class=\"token string\">\"bgr\"</span><span class=\"token punctuation\">,</span> use_video_port<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    image <span class=\"token operator\">=</span> frame<span class=\"token punctuation\">.</span>array\n    raw_capture<span class=\"token punctuation\">.</span>truncate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    raw_capture<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    \n    maybe_motion_text <span class=\"token operator\">=</span> <span class=\"token string\">\"Not Detected\"</span>\n    <span class=\"token keyword\">if</span> image <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">break</span>\n\n    current_frame <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>cvtColor<span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span>cv2<span class=\"token punctuation\">.</span>COLOR_BGR2GRAY<span class=\"token punctuation\">)</span>\n    current_frame <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>GaussianBlur<span class=\"token punctuation\">(</span>current_frame<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token number\">21</span><span class=\"token punctuation\">,</span><span class=\"token number\">21</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> reference_frame <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n        reference_frame <span class=\"token operator\">=</span> current_frame\n        <span class=\"token keyword\">continue</span>\n        \n    frame_delta <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>absdiff<span class=\"token punctuation\">(</span>reference_frame<span class=\"token punctuation\">,</span>current_frame<span class=\"token punctuation\">)</span>\n    thresh <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>threshold<span class=\"token punctuation\">(</span>frame_delta<span class=\"token punctuation\">,</span> <span class=\"token number\">25</span><span class=\"token punctuation\">,</span><span class=\"token number\">255</span><span class=\"token punctuation\">,</span>cv2<span class=\"token punctuation\">.</span>THRESH_BINARY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n    \n    thresh <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>dilate<span class=\"token punctuation\">(</span>thresh<span class=\"token punctuation\">,</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span>iterations<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n    cnts <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>findContours<span class=\"token punctuation\">(</span>thresh<span class=\"token punctuation\">.</span>copy<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> cv2<span class=\"token punctuation\">.</span>RETR_EXTERNAL<span class=\"token punctuation\">,</span>\n            cv2<span class=\"token punctuation\">.</span>CHAIN_APPROX_SIMPLE<span class=\"token punctuation\">)</span>\n    cnts <span class=\"token operator\">=</span> imutils<span class=\"token punctuation\">.</span>grab_contours<span class=\"token punctuation\">(</span>cnts<span class=\"token punctuation\">)</span>\n        \n    <span class=\"token keyword\">for</span> c <span class=\"token keyword\">in</span> cnts<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> cv2<span class=\"token punctuation\">.</span>contourArea<span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> min_area<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">continue</span>\n        <span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>w<span class=\"token punctuation\">,</span>h<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>boundingRect<span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span>\n        cv2<span class=\"token punctuation\">.</span>rectangle<span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>x<span class=\"token operator\">+</span>w<span class=\"token punctuation\">,</span>y<span class=\"token operator\">+</span>h<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">255</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n        maybe_motion_text <span class=\"token operator\">=</span> <span class=\"token string\">\"Detected\"</span>\n        \n    cv2<span class=\"token punctuation\">.</span>putText<span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Motion: {}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>maybe_motion_text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> cv2<span class=\"token punctuation\">.</span>FONT_HERSHEY_SIMPLEX<span class=\"token punctuation\">,</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n    cv2<span class=\"token punctuation\">.</span>putText<span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span> datetime<span class=\"token punctuation\">.</span>datetime<span class=\"token punctuation\">.</span>now<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strftime<span class=\"token punctuation\">(</span><span class=\"token string\">\"%A %d %B %Y %I: %M: %S%p\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span>image<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> cv2<span class=\"token punctuation\">.</span>FONT_HERSHEY_SIMPLEX<span class=\"token punctuation\">,</span> <span class=\"token number\">0.35</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        \n    cv2<span class=\"token punctuation\">.</span>imshow<span class=\"token punctuation\">(</span><span class=\"token string\">\"Feed\"</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">)</span>\n    cv2<span class=\"token punctuation\">.</span>imshow<span class=\"token punctuation\">(</span><span class=\"token string\">\"Threshold\"</span><span class=\"token punctuation\">,</span> thresh<span class=\"token punctuation\">)</span>\n    cv2<span class=\"token punctuation\">.</span>imshow<span class=\"token punctuation\">(</span><span class=\"token string\">\"Frame Delta\"</span><span class=\"token punctuation\">,</span> frame_delta<span class=\"token punctuation\">)</span>\n    \n    key <span class=\"token operator\">=</span> cv2<span class=\"token punctuation\">.</span>waitKey<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> key <span class=\"token operator\">==</span> <span class=\"token builtin\">ord</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"q\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">break</span>\n\ncv2<span class=\"token punctuation\">.</span>destroyAllWindows<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>","frontmatter":{"date":"June 21, 2023","slug":"/camp/day3","title":"Day 3"}}},"pageContext":{"slug":"/camp/day3"}},"staticQueryHashes":[]}